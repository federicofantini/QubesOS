<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="refresh" content="30">
  <title>Pr0cks Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .topology-wrapper { position: relative; }
    #linkCanvas { position: absolute; inset: 0; pointer-events: none; }
    .vm-card, .proxy-card { cursor: pointer; transition: transform .1s ease-in-out; }
    .vm-card:hover, .proxy-card:hover { transform: translateY(-1px); }
    .selected { outline: 2px dashed #0d6efd; }
    .scroll-area { max-height: 360px; overflow: auto; }
    code { user-select: all; }
  </style>
</head>
<body class="bg-light">

<div class="container py-5">
  <h1 class="mb-4 text-center">Pr0cks Manager</h1>

  <div class="d-flex flex-wrap gap-2 mb-4 justify-content-center">
    <a class="btn btn-outline-success" href="?action=export_all">Export all (JSON)</a>
    <label class="btn btn-outline-dark mb-0">
      Import all <input type="file" id="importAllFile" accept="application/json" hidden>
    </label>
  </div>

  <!-- Topology Map -->
  <div class="card shadow-sm mb-5">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Topology — connect VMs to Proxies</span>
      <div class="d-flex gap-2">
        <button id="linkModeBtn" class="btn btn-sm btn-outline-primary">Link mode: OFF</button>
        <button id="redrawBtn" class="btn btn-sm btn-outline-secondary">Redraw lines</button>
      </div>
    </div>
    <div class="card-body topology-wrapper">
      <svg id="linkCanvas"></svg>
      <div class="row">
        <div class="col-md-5">
          <h6 class="text-muted mb-2">VMs</h6>
          <div id="vmList" class="scroll-area">
            {% if vms %}
              {% for vm in vms %}
                <div class="card vm-card mb-2" data-vm-id="{{ vm.id }}">
                  <div class="card-body py-2 d-flex justify-content-between align-items-center">
                    <div>
                      <div><strong>{{ vm.name }}</strong></div>
                      <div class="text-muted small">{{ vm.ip|default:"(no IP yet)" }}</div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-muted">No VMs saved</div>
            {% endif %}
          </div>
        </div>

        <div class="col-md-2 d-flex align-items-center justify-content-center">
          <div class="text-center">
            <div style="color:lightgrey">Bindings</div>
          </div>
        </div>

        <div class="col-md-5">
          <h6 class="text-muted mb-2">Proxies</h6>
          <div id="proxyList" class="scroll-area">
            {% if configs %}
              {% for cfg in configs %}
                <div class="card proxy-card mb-2" data-proxy-id="{{ cfg.id }}"
                     data-lp="{{ cfg.local_proxy }}" data-ld="{{ cfg.local_dns }}">
                  <div class="card-body py-2 d-flex justify-content-between align-items-center">
                    <div>
                      <div><strong>{% if cfg.name %}[{{ cfg.name }}]{% else %}Proxy #{{ cfg.id }}{% endif %}</strong></div>
                      <div class="small">
                        <code>{{ cfg.local_proxy }}</code> / <code>{{ cfg.local_dns }}</code>
                      </div>
                      <div class="text-muted small">{{ cfg.remote_socks5 }}</div>
                    </div>
                    <div class="form-check form-switch ms-2">
                      <input class="form-check-input proxy-active-switch"
                             type="checkbox"
                             title="Abilita/Disabilita e avvia/termina il proxy"
                             data-id="{{ cfg.id }}"
                             {% if cfg.active %}checked{% endif %}>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-muted">No proxies saved</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Proxy -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">Add new proxy</div>
    <div class="card-body">
      <form id="addForm" method="post">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-3">
            <label for="name" class="form-label">Name (optional)</label>
            <input type="text" id="name" name="name" class="form-control" placeholder="clearnet / vpn / tor">
          </div>
          <div class="col-md-3">
            <label for="local_proxy" class="form-label">Local proxy (IP:port)</label>
            <input type="text" id="local_proxy" name="local_proxy" class="form-control" placeholder="127.0.0.1:12345" required>
          </div>
          <div class="col-md-3">
            <label for="local_dns" class="form-label">Local DNS (IP:port)</label>
            <input type="text" id="local_dns" name="local_dns" class="form-control" placeholder="127.0.0.1:1053" required>
          </div>
          <div class="col-md-3">
            <label for="remote_socks5" class="form-label">Remote SOCKS5 (host/ip:port)</label>
            <input type="text" id="remote_socks5" name="remote_socks5" class="form-control" placeholder="socks.example.com:1080" required>
          </div>
        </div>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" value="true" id="active" name="active" checked>
          <label class="form-check-label" for="active">
            Enable now (and persist)
          </label>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-success w-100">Add proxy</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add VM -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white">Add VM</div>
    <div class="card-body">
      <form id="addVmForm" method="post">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-5">
            <label for="vm_name" class="form-label">VM Name</label>
            <input type="text" id="vm_name" name="vm_name" class="form-control" placeholder="win10" required>
          </div>
          <div class="col-md-5">
            <label for="vm_ip" class="form-label">IP (required for bindings)</label>
            <input type="text" id="vm_ip" name="vm_ip" class="form-control" placeholder="192.168.122.10">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-info w-100 text-white">Add VM</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- VMs -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white">VMs</div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>IP</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          {% if vms %}
            {% for vm in vms %}
            <tr data-vm-row="{{ vm.id }}">
              <td>{{ vm.id }}</td>
              <td>{{ vm.name }}</td>
              <td><code>{{ vm.ip|default:"-" }}</code></td>
              <td class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-danger delete-vm" data-id="{{ vm.id }}">Delete</button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="4" class="text-center text-muted">No VMs saved</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Proxies table -->
  <div class="card shadow-sm mb-5">
    <div class="card-header bg-dark text-white">Proxies</div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Local proxy</th>
              <th>Local DNS</th>
              <th>Remote SOCKS5</th>
              <th>Enabled</th>
              <th>PID</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          {% if configs %}
            {% for cfg in configs %}
            <tr data-proxy-row="{{ cfg.id }}">
              <td>{{ cfg.id }}</td>
              <td>{% if cfg.name %}<strong>{{ cfg.name }}</strong>{% else %}-{% endif %}</td>
              <td><code>{{ cfg.local_proxy }}</code></td>
              <td><code>{{ cfg.local_dns }}</code></td>
              <td><code>{{ cfg.remote_socks5 }}</code></td>
              <td>
                <div class="form-check form-switch">
                  <input class="form-check-input proxy-active-switch"
                         type="checkbox"
                         data-id="{{ cfg.id }}"
                         {% if cfg.active %}checked{% endif %}>
                </div>
              </td>
              <td>{{ cfg.pid|default:"-" }}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger delete-proxy" data-id="{{ cfg.id }}">Delete</button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="8" class="text-center text-muted">No proxies saved</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bindings -->
  <div class="card shadow-sm mb-5">
    <div class="card-header bg-dark text-white">Binding Rules</div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>VM</th>
              <th>Proxy</th>
              <th>proxy_port</th>
              <th>dns_port</th>
              <th>Enabled</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          {% if bindings %}
            {% for b in bindings %}
            <tr data-binding-row="{{ b.id }}">
              <td>{{ b.id }}</td>
              <td>{{ b.vm.name }} ({{ b.vm.ip|default:"no-ip" }})</td>
              <td>
                {% if b.pr0cks.name %}[{{ b.pr0cks.name }}]{% else %}#{{ b.pr0cks.id }}{% endif %}
                — {{ b.pr0cks.local_proxy }} / {{ b.pr0cks.local_dns }}
              </td>
              <td>{{ b.proxy_port }}</td>
              <td>{{ b.dns_port }}</td>
              <td>
                <div class="form-check form-switch">
                  <input class="form-check-input binding-enabled-switch"
                         type="checkbox"
                         data-id="{{ b.id }}"
                         {% if b.enabled %}checked{% endif %}>
                </div>
              </td>
              <td class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-danger delete-binding" data-id="{{ b.id }}">Delete</button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="7" class="text-center text-muted">No bindings defined</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="alert mt-4 d-none" id="outputBox"></div>
  <script id="bindings-json" type="application/json">{{ bindings_json|safe }}</script>
</div>

<script>
  // CSRF
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  const outputBox = document.getElementById('outputBox');
  function showMessage(msg, type="info") {
    outputBox.className = "alert alert-" + type;
    outputBox.textContent = msg;
    outputBox.classList.remove("d-none");
  }
  function reloadSoon(ms=900){ setTimeout(() => location.reload(), ms); }

  // Proxy: Add
  document.getElementById('addForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    fd.append("action", "proxy_add");
    if (!fd.has("active")) fd.append("active", "false");
    const r = await fetch("", { method: "POST", body: fd, headers: { "X-CSRFToken": csrftoken }});
    const j = await r.json();
    if (j.ok) showMessage("Proxy added", "success"); else showMessage(j.error || "Error", "danger");
    reloadSoon();
  });

  // Proxy: toggle (persist + start/stop)
  document.querySelectorAll(".proxy-active-switch").forEach(sw => {
    sw.addEventListener("change", async () => {
      const id = sw.dataset.id;
      const active = sw.checked ? "true" : "false";
      const fd = new FormData();
      fd.append("action", "proxy_set_active");
      fd.append("id", id);
      fd.append("active", active);
      const r = await fetch("", { method: "POST", body: fd, headers: { "X-CSRFToken": csrftoken }});
      const j = await r.json();
      if (j.ok) showMessage(`Proxy ${id} set enabled=${active}`, "success");
      else { showMessage(j.error || "Error", "danger"); sw.checked = !sw.checked; }
    });
  });

  // Proxy: delete
  document.querySelectorAll(".delete-proxy").forEach(btn => {
    btn.addEventListener("click", async () => {
      if (!confirm("Delete this proxy?")) return;
      const fd = new FormData();
      fd.append("action", "proxy_delete");
      fd.append("id", btn.dataset.id);
      const r = await fetch("", { method: "POST", body: fd, headers: { "X-CSRFToken": csrftoken }});
      const j = await r.json();
      if (j.ok) showMessage("Proxy deleted", "success"); else showMessage(j.error || "Error", "danger");
      reloadSoon();
    });
  });

  // VM: Add
  document.getElementById('addVmForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('vm_name').value.trim();
    const ip = document.getElementById('vm_ip').value.trim();
    const fd = new FormData();
    fd.append("action", "vm_add");
    fd.append("name", name);
    if (ip) fd.append("ip", ip);
    const r = await fetch("", { method: "POST", body: fd, headers: { "X-CSRFToken": csrftoken }});
    const j = await r.json();
    if (j.ok) showMessage(`VM ${name} added`, "success"); else showMessage(j.error || "Error", "danger");
    reloadSoon();
  });

  // VM: delete
  document.querySelectorAll(".delete-vm").forEach(btn => {
    btn.addEventListener("click", async () => {
      if (!confirm("Delete this VM?")) return;
      const fd = new FormData();
      fd.append("action", "vm_delete");
      fd.append("id", btn.dataset.id);
      const r = await fetch("", { method: "POST", body: fd, headers: { "X-CSRFToken": csrftoken }});
      const j = await r.json();
      if (j.ok) showMessage("VM deleted", "success"); else showMessage(j.error || "Error", "danger");
      reloadSoon();
    });
  });

  // Link mode (drag VM -> click Proxy)
  let linkMode = false;
  let selectedVmCard = null;
  let dragLine = null;

  const linkModeBtn = document.getElementById("linkModeBtn");
  const topology = document.querySelector(".topology-wrapper");
  const svg = document.getElementById("linkCanvas");
  svg.style.pointerEvents = "auto";

  function ensureArrowDef() {
    const NS = "http://www.w3.org/2000/svg";
    let defs = svg.querySelector("defs");
    if (!defs) { defs = document.createElementNS(NS, "defs"); svg.appendChild(defs); }
    if (!svg.querySelector("#arrowhead")) {
      const marker = document.createElementNS(NS, "marker");
      marker.setAttribute("id", "arrowhead");
      marker.setAttribute("markerWidth", "10");
      marker.setAttribute("markerHeight", "7");
      marker.setAttribute("refX", "10");
      marker.setAttribute("refY", "3.5");
      marker.setAttribute("orient", "auto");
      const poly = document.createElementNS(NS, "polygon");
      poly.setAttribute("points", "0 0, 10 3.5, 0 7");
      poly.setAttribute("fill", "#198754");
      marker.appendChild(poly);
      defs.appendChild(marker);
    }
  }

  function getRect(el){ return el.getBoundingClientRect(); }
  function topoRect(){ return topology.getBoundingClientRect(); }
  function vmCenterRight(el){ const r=getRect(el), t=topoRect(); return {x:r.right-t.left, y:r.top-t.top+r.height/2}; }
  function proxyCenterLeft(el){ const r=getRect(el), t=topoRect(); return {x:r.left-t.left, y:r.top-t-top+r.height/2}; }
  // (fix: t-top typo)
  function proxyCenterLeft(el){ const r=getRect(el), t=topoRect(); return {x:r.left-t.left, y:r.top-t.top+r.height/2}; }
  function pathD(x1,y1,x2,y2){ const dx=Math.abs(x2-x1)*0.35; return `M ${x1} ${y1} C ${x1+dx} ${y1}, ${x2-dx} ${y2}, ${x2} ${y2}`; }

  function startDrag(vmCard){
    ensureArrowDef();
    selectedVmCard = vmCard;
    selectedVmCard.classList.add("selected");
    if (dragLine) svg.removeChild(dragLine);
    const NS = "http://www.w3.org/2000/svg";
    dragLine = document.createElementNS(NS, "path");
    dragLine.setAttribute("fill", "none");
    dragLine.setAttribute("stroke", "#198754");
    dragLine.setAttribute("stroke-width", "2.5");
    dragLine.setAttribute("stroke-opacity", "0.9");
    dragLine.setAttribute("marker-end", "url(#arrowhead)");
    svg.appendChild(dragLine);
    updateDragLineToMouse(lastMouse.x, lastMouse.y);
  }

  function endDrag(){
    if (selectedVmCard) selectedVmCard.classList.remove("selected");
    selectedVmCard = null;
    if (dragLine){ svg.removeChild(dragLine); dragLine = null; }
  }

  let lastMouse = {x:0,y:0};
  function updateDragLineToMouse(mx,my){
    if (!dragLine || !selectedVmCard) return;
    const a = vmCenterRight(selectedVmCard);
    const t = topoRect();
    const x2 = Math.max(0, Math.min(mx - t.left, t.width));
    const y2 = Math.max(0, Math.min(my - t.top, t.height));
    dragLine.setAttribute("d", pathD(a.x, a.y, x2, y2));
  }
  function updateDragLineToProxy(proxyCard){
    if (!dragLine || !selectedVmCard) return;
    const a = vmCenterRight(selectedVmCard);
    const b = proxyCenterLeft(proxyCard);
    dragLine.setAttribute("d", pathD(a.x, a.y, b.x, b.y));
  }

  linkModeBtn.addEventListener("click", () => {
    linkMode = !linkMode;
    linkModeBtn.textContent = linkMode ? "Link mode: ON" : "Link mode: OFF";
    if (!linkMode) endDrag();
  });

  document.addEventListener("mousemove", (e) => {
    lastMouse = {x:e.clientX, y:e.clientY};
    updateDragLineToMouse(e.clientX, e.clientY);
  }, true);

  document.querySelectorAll(".vm-card").forEach(card => {
    card.addEventListener("click", () => {
      if (!linkMode) return;
      startDrag(card);
    });
  });

  document.querySelectorAll(".proxy-card").forEach(card => {
    card.addEventListener("mouseenter", () => {
      if (!linkMode || !selectedVmCard) return;
      updateDragLineToProxy(card);
      card.classList.add("selected");
    });
    card.addEventListener("mouseleave", () => {
      card.classList.remove("selected");
      if (linkMode && selectedVmCard) updateDragLineToMouse(lastMouse.x, lastMouse.y);
    });
    card.addEventListener("click", async () => {
      if (!linkMode || !selectedVmCard) return;
      const vmId = selectedVmCard.getAttribute("data-vm-id");
      const proxyId = card.getAttribute("data-proxy-id");

      // 1) crea binding
      const fd = new FormData();
      fd.append("action", "binding_create");
      fd.append("vm_id", vmId);
      fd.append("pr0cks_id", proxyId);

      const r = await fetch("", { method: "POST", body: fd, headers: { "X-CSRFToken": csrftoken }});
      const j = await r.json();

      if (j.ok && j.id) {
        // 2) abilita subito il binding appena creato
        const fd2 = new FormData();
        fd2.append("action", "binding_enable");
        fd2.append("binding_id", j.id);
        const r2 = await fetch("", { method: "POST", body: fd2, headers: { "X-CSRFToken": csrftoken }});
        const j2 = await r2.json();
        if (j2.ok) {
          showMessage(`Binding #${j.id} creato e abilitato`, "success");
        } else {
          const err = j2.error || (j2.errors ? j2.errors.join("; ") : "enable failed");
          showMessage(`Binding creato (#${j.id}) ma enable fallito: ${err}`, "warning");
        }
      } else {
        showMessage(j.error || "Error creating binding", "danger");
      }

      endDrag();
      linkMode = false;
      linkModeBtn.textContent = "Link mode: OFF";
      reloadSoon();
    });
  });

  // Binding: enable/disable
  document.querySelectorAll(".binding-enabled-switch").forEach(sw => {
    sw.addEventListener("change", async () => {
      const id = sw.dataset.id;
      const enable = sw.checked;
      const fd = new FormData();
      fd.append("action", enable ? "binding_enable" : "binding_disable");
      fd.append("binding_id", id);
      const r = await fetch("", { method: "POST", body: fd, headers: { "X-CSRFToken": csrftoken }});
      const j = await r.json();
      if (j.ok) {
        showMessage(`Binding ${id} ${enable ? "enabled" : "disabled"}`, "success");
        reloadSoon();
      } else {
        const err = j.error || (j.errors ? j.errors.join("; ") : "Error");
        showMessage(err, "danger");
        sw.checked = !enable; // revert UI
      }
    });
  });

  // Binding: delete
  document.querySelectorAll(".delete-binding").forEach(btn => {
    btn.addEventListener("click", async () => {
      if (!confirm("Delete this binding?")) return;
      const fd = new FormData();
      fd.append("action", "binding_delete");
      fd.append("binding_id", btn.dataset.id);
      const r = await fetch("", { method: "POST", body: fd, headers: { "X-CSRFToken": csrftoken }});
      const j = await r.json();
      if (j.ok) {
        showMessage("Binding deleted", "success");
        reloadSoon();
      } else {
        showMessage(j.error || "Error", "danger");
      }
    });
  });

  // Topology lines
  function drawLines() {
    const rect = document.querySelector(".topology-wrapper").getBoundingClientRect();
    const svg = document.getElementById("linkCanvas");
    svg.setAttribute("width", rect.width);
    svg.setAttribute("height", rect.height);
    Array.from(svg.children).forEach(ch => { if (ch.tagName.toLowerCase() !== 'defs') svg.removeChild(ch); });

    (function ensure(){
      const NS = "http://www.w3.org/2000/svg";
      let defs = svg.querySelector("defs");
      if (!defs) { defs = document.createElementNS(NS, "defs"); svg.appendChild(defs); }
      if (!svg.querySelector("#arrowhead")) {
        const marker = document.createElementNS(NS, "marker");
        marker.setAttribute("id", "arrowhead");
        marker.setAttribute("markerWidth", "10");
        marker.setAttribute("markerHeight", "7");
        marker.setAttribute("refX", "10");
        marker.setAttribute("refY", "3.5");
        marker.setAttribute("orient", "auto");
        const poly = document.createElementNS(NS, "polygon");
        poly.setAttribute("points", "0 0, 10 3.5, 0 7");
        poly.setAttribute("fill", "#198754");
        marker.appendChild(poly);
        defs.appendChild(marker);
      }
    })();

    const dataEl = document.getElementById("bindings-json");
    let bindings = [];
    try { bindings = JSON.parse(dataEl.textContent || "[]"); } catch (e) {}

    const vmMap = {};
    document.querySelectorAll(".vm-card").forEach(el => vmMap[el.getAttribute("data-vm-id")] = el);
    const proxyMap = {};
    document.querySelectorAll(".proxy-card").forEach(el => proxyMap[el.getAttribute("data-proxy-id")] = el);

    const NS = "http://www.w3.org/2000/svg";
    function getRect(el){ return el.getBoundingClientRect(); }
    function topoRect(){ return document.querySelector(".topology-wrapper").getBoundingClientRect(); }
    function vmCenterRight(el){ const r=getRect(el), t=topoRect(); return {x:r.right-t.left, y:r.top-t.top+r.height/2}; }
    function proxyCenterLeft(el){ const r=getRect(el), t=topoRect(); return {x:r.left-t.left, y:r.top-t.top+r.height/2}; }
    function pathD(x1,y1,x2,y2){ const dx=Math.abs(x2-x1)*0.35; return `M ${x1} ${y1} C ${x1+dx} ${y1}, ${x2-dx} ${y2}, ${x2} ${y2}`; }

    bindings.forEach(b => {
      const vmEl = vmMap[b.vm_id || (b.vm && b.vm.id)];
      const prEl = proxyMap[b.pr0cks_id || (b.pr0cks && b.pr0cks.id)];
      if (!vmEl || !prEl) return;

      const a = vmCenterRight(vmEl);
      const c = proxyCenterLeft(prEl);

      const path = document.createElementNS(NS, "path");
      path.setAttribute("d", pathD(a.x, a.y, c.x, c.y));
      path.setAttribute("fill", "none");
      path.setAttribute("stroke", b.enabled ? "#198754" : "#6c757d");
      path.setAttribute("stroke-width", "2.5");
      path.setAttribute("stroke-opacity", "0.9");
      path.setAttribute("marker-end", "url(#arrowhead)");
      svg.appendChild(path);
    });
  }
  window.addEventListener("resize", drawLines);
  document.getElementById("redrawBtn").addEventListener("click", drawLines);
  window.addEventListener("load", () => setTimeout(drawLines, 100));
  document.addEventListener("scroll", drawLines, true);

  // Import ALL
  document.getElementById("importAllFile").addEventListener("change", async (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const fd = new FormData();
    fd.append("action", "import_all");
    fd.append("file", f, f.name);
    const r = await fetch("", { method: "POST", body: fd, headers: { "X-CSRFToken": csrftoken }});
    const ct = r.headers.get("content-type") || "";
    if (ct.includes("application/json")) {
      const j = await r.json();
      const msg = `Imported ALL — proxies:${j.proxies||0}, vms:${j.vms||0}, bindings:${j.bindings||0}` + (j.errors?.length ? ` — Errors: ${j.errors.join("; ")}` : "");
      showMessage(msg, j.errors?.length ? "warning" : "success");
    } else {
      const txt = await r.text();
      showMessage(txt || "Import ALL response", r.ok ? "success" : "danger");
    }
    reloadSoon();
  });
</script>

</body>
</html>
